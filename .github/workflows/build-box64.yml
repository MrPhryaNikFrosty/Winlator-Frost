name: Build Box64 for Android (Fixed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y ninja-build zip

      - name: Download Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip -q android-ndk-r26d-linux.zip
          mv android-ndk-r26d $HOME/android-ndk

      - name: Configure and build Box64
        run: |
          export ANDROID_NDK_HOME=$HOME/android-ndk
          export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64

          rm -rf build-android
          mkdir build-android
          cd build-android

          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID=ON \
            -DCMAKE_ANDROID_NDK=$ANDROID_NDK_HOME \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=21 \
            -DCMAKE_C_COMPILER=$TOOLCHAIN/bin/aarch64-linux-android21-clang \
            -DCMAKE_CXX_COMPILER=$TOOLCHAIN/bin/aarch64-linux-android21-clang++ \
            -DARM_DYNAREC=ON \
            -DBUILD_SHARED_LIBS=OFF \
            -DPLATFORM=android

          ninja -j$(nproc)

      - name: Package artifacts
        run: |
          cd build-android
          zip -r box64-android.zip .

      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: box64-android
          path: build-android/box64-android.zip
