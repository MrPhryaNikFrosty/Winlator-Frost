name: Build Box64 For Winlator Frost

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y ninja-build cmake git build-essential

    - name: Download Android NDK
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
        unzip android-ndk-r26d-linux.zip
        mv android-ndk-r26d $HOME/android-ndk
        echo "ANDROID_NDK_HOME=$HOME/android-ndk" >> $GITHUB_ENV

    - name: Clone Box64
      run: |
        git clone https://github.com/ptitSeb/box64.git
        cd box64
        git checkout master

    - name: Apply Android Patch (Fix fseeko64 + dlvsym + int128)
      run: |
        cd box64/src/elfs

        # Fix missing fseeko64()
        sed -i 's/fseeko64/fseeko/g' elfloader.c

        # Remove dlvsym() usage â€” Android does not support versioned symbols
        sed -i 's/dlvsym/dlsym/g' elfloader.c

        # Ensure no leftover implicit dlvsym prototype
        sed -i 's/.*dlvsym.*//g' elfloader.c

        # Ensure missing __int128 is not used anywhere else (Android safe)
        cd ..
        grep -rl "__int128" . | xargs sed -i 's/__int128/long long/g'

    - name: Configure Box64
      run: |
        cd box64
        cmake -B build \
            -G Ninja \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_ANDROID_NDK=$ANDROID_NDK_HOME \
            -DCMAKE_SYSTEM_VERSION=21 \
            -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
            -DCMAKE_ANDROID_STL_TYPE=none \
            -DANDROID=1 \
            -DARM64=1 \
            -DDYNAREC=1 \
            -DCMAKE_BUILD_TYPE=Release

    - name: Build Box64
      run: |
        cd box64/build
        ninja -j$(nproc)

    - name: Upload Result
      uses: actions/upload-artifact@v4
      with:
        name: box64-android-build
        path: box64/build/box64
