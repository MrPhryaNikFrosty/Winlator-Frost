name: Build Turnip Vulkan Driver for ARM64 (Winlator-Compatible)

on:
  workflow_dispatch:

jobs:
  build-turnip:
    runs-on: ubuntu-22.04

    steps:
      # --- Enable QEMU emulation for ARM64 ---
      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      # --- Clone Mesa Source ---
      - name: Clone Mesa
        run: |
          git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          git log -1

      # --- Build Mesa Turnip inside ARM64 container ---
      - name: Build Mesa Turnip (ARM64)
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/work \
            ubuntu:24.04 \
            bash -c "
              set -e
              export DEBIAN_FRONTEND=noninteractive
              apt-get update && apt-get install -y \
                python3 python3-pip python3-venv python3-mako python3-setuptools python3-wheel python3-yaml \
                cmake pkg-config git llvm clang zlib1g-dev \
                libdrm-dev libexpat1-dev libwayland-dev wayland-protocols \
                libx11-dev libxext-dev libxdamage-dev libxfixes-dev \
                libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev \
                libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev \
                libxcb-glx0-dev libxcb-shm0-dev flex bison byacc curl && \
              
              # --- Install Meson & Ninja (modern versions) ---
              python3 -m venv /opt/venv && \
              . /opt/venv/bin/activate && \
              pip install --upgrade meson ninja mako packaging pyyaml

              # --- Build SPIR-V Headers ---
              cd /work && \
              git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Headers.git && \
              cp -r SPIRV-Headers/include/spirv /usr/include/

              # --- Build SPIR-V Tools ---
              git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Tools.git && \
              cd SPIRV-Tools && python3 utils/git-sync-deps && \
              mkdir build && cd build && \
              cmake -DCMAKE_BUILD_TYPE=Release \
                    -DCMAKE_INSTALL_PREFIX=/usr \
                    -DSPIRV_SKIP_TESTS=ON .. && \
              make -j$(nproc) && make install

              # --- Build glslang (ARM64) ---
              cd /work && git clone --depth=1 https://github.com/KhronosGroup/glslang.git && \
              cd glslang && mkdir build && cd build && \
              cmake -DCMAKE_BUILD_TYPE=Release \
                    -DCMAKE_INSTALL_PREFIX=/usr \
                    -DENABLE_OPT=ON \
                    -DALLOW_EXTERNAL_SPIRV_TOOLS=ON \
                    -DSPIRV_TOOLS_INCLUDE_DIR=/usr/include/spirv-tools \
                    -DSPIRV_TOOLS_LIBRARY_DIR=/usr/lib .. || \
              (echo 'Retrying glslang with ENABLE_OPT=OFF' && rm -rf * && \
               cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_OPT=OFF -DCMAKE_INSTALL_PREFIX=/usr ..) && \
              make -j$(nproc) && make install && \
              which glslangValidator && glslangValidator --version || echo 'glslangValidator OK'

              # --- Build Mesa Turnip (freedreno) ---
              cd /work/mesa && \
              . /opt/venv/bin/activate && \
              meson setup build/ \
                --prefix=/work/install \
                --libdir=lib \
                -Dplatforms=x11,wayland \
                -Dvulkan-drivers=freedreno \
                -Dgallium-drivers=freedreno \
                -Dbuildtype=release && \
              ninja -C build && ninja -C build install
            "

      # --- Upload Compiled Turnip Vulkan Driver ---
      - name: Upload Turnip Vulkan Driver
        uses: actions/upload-artifact@v4
        with:
          name: Mesa-Turnip-ARM64
          path: install/lib/libvulkan_freedreno.so
