name: Build Mesa Turnip (ARM64)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------
      # 1. Checkout repository
      # ----------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------
      # 2. Prepare Environment
      # ----------------------------------------
      - name: Prepare Environment (Host)
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            git wget curl ca-certificates software-properties-common \
            python3 python3-pip python3-venv python3-yaml pkg-config \
            cmake ninja-build build-essential clang llvm \
            qemu-user-static binfmt-support \
            crossbuild-essential-arm64 gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libwayland-dev wayland-protocols wayland-scanner++ \
            libx11-dev libxext-dev libxdamage-dev libxfixes-dev \
            libxcb-glx0-dev libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev \
            libxcb-sync-dev libxshmfence-dev libxxf86vm-dev libvulkan-dev \
            libdrm-dev libexpat1-dev libelf-dev bison flex zlib1g-dev \
            spirv-tools

          # Upgrade pip and install latest Meson, Mako, PyYAML in user env
          python3 -m pip install --upgrade pip
          python3 -m pip install --user --upgrade meson mako pyyaml

          # Make sure Python user binaries are preferred
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/bin:$PATH"

          echo "✅ Environment ready"
          meson --version

      # ----------------------------------------
      # 3. Clone Mesa source
      # ----------------------------------------
      - name: Clone Mesa source
        run: |
          set -e
          if [ ! -d "${{ github.workspace }}/mesa" ]; then
            git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git ${{ github.workspace }}/mesa
          else
            cd ${{ github.workspace }}/mesa
            git fetch origin main || true
          fi

      # ----------------------------------------
      # 4. Build glslang (for SPIR-V tools)
      # ----------------------------------------
      - name: Build glslang (for SPIR-V)
        run: |
          set -e
          cd ${{ github.workspace }}
          if [ ! -d glslang ]; then
            git clone --depth=1 https://github.com/KhronosGroup/glslang.git
          fi
          cd glslang
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_OPT=OFF .
          ninja
          sudo cp StandAlone/glslangValidator /usr/local/bin/
          glslangValidator --version || true

      # ----------------------------------------
      # 5. Build Mesa Turnip (ARM64)
      # ----------------------------------------
      - name: Build Mesa Turnip (ARM64)
        run: |
          set -e
          cd ${{ github.workspace }}/mesa

          # Ensure Meson version is correct
          echo "Meson version check:"
          meson --version

          # Ensure glslangValidator exists
          which glslangValidator || (echo "❌ glslangValidator missing!" && exit 1)

          echo "🧩 Creating ARM64 cross file..."
          cat > cross_file.txt <<'EOF'
          [binaries]
          c = 'aarch64-linux-gnu-gcc'
          cpp = 'aarch64-linux-gnu-g++'
          ar = 'aarch64-linux-gnu-ar'
          strip = 'aarch64-linux-gnu-strip'
          pkgconfig = 'pkg-config'
          exe_wrapper = 'qemu-aarch64-static'

          [host_machine]
          system = 'linux'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'
          EOF

          mkdir -p build && cd build

          meson setup --cross-file ../cross_file.txt \
            -Dplatforms=x11,wayland \
            -Dvulkan-drivers=freedreno \
            -Dgallium-drivers=[] \
            -Dbuildtype=release \
            -Doptimization=3 \
            -Dglx=disabled \
            -Degl=disabled \
            -Dshared-glapi=disabled \
            -Dgles1=disabled \
            -Dgles2=disabled \
            -Dopengl=false \
            -Dllvm=disabled \
            -Dprefix=/usr/local \
            ..
          
          ninja install

      # ----------------------------------------
      # 6. Upload Result
      # ----------------------------------------
      - name: Upload libvulkan_freedreno.so
        uses: actions/upload-artifact@v4
        with:
          name: libvulkan_freedreno-arm64
          path: |
            ${{ github.workspace }}/mesa/build/src/freedreno/vulkan/libvulkan_freedreno.so
