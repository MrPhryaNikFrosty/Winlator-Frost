name: Build Turnip (Mesa Aarch64)

on:
  workflow_dispatch:

jobs:
  build-turnip:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up APT repositories (fix 404)
        run: |
          sudo sed -i 's|http://.*.ubuntu.com/ubuntu/|http://archive.ubuntu.com/ubuntu/|g' /etc/apt/sources.list
          sudo apt-get clean
          sudo apt-get update -y

      - name: Install build dependencies
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update -y
          sudo apt-get install -y \
            git cmake ninja-build meson python3-mako python3-pip python3-setuptools python3-wheel \
            pkg-config pkgconf flex bison gettext \
            llvm llvm-dev clang spirv-tools libclc-dev \
            libx11-dev libx11-dev:arm64 libx11-xcb-dev libx11-xcb-dev:arm64 \
            libxcb1-dev libxcb1-dev:arm64 libxcb-dri2-0-dev libxcb-dri3-dev \
            libxcb-present-dev libxcb-randr0-dev libxcb-shm0-dev \
            libxcb-sync-dev libxext-dev libxdamage-dev \
            libxfixes-dev libxrandr-dev libxxf86vm-dev \
            libxshmfence-dev libdrm-dev libdrm-dev:arm64 \
            libwayland-dev libwayland-server0:arm64 wayland-protocols \
            zlib1g-dev zlib1g-dev:arm64 \
            libexpat1-dev libelf-dev libunwind-dev libomxil-bellagio-dev \
            glslang-tools vulkan-tools spirv-headers \
            qemu-user-static gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Verify cross-compilation toolchain
        run: |
          aarch64-linux-gnu-gcc --version
          aarch64-linux-gnu-g++ --version

      - name: Prepare Mesa source tree
        run: |
          cd mesa
          git submodule update --init --recursive
          meson setup build \
            --cross-file cross_file.txt \
            --buildtype release \
            -Dplatforms=x11,wayland,drm,surfaceless \
            -Dvulkan-drivers=freedreno \
            -Dgallium-drivers=freedreno,swrast,virgl \
            -Dllvm=true \
            -Dshared-llvm=true \
            -Dbuild-tests=false \
            -Dprefix=/usr \
            --libdir=lib/aarch64-linux-gnu

      - name: Build Mesa (Turnip)
        run: |
          cd mesa/build
          ninja -v

      - name: Package Mesa output
        run: |
          cd mesa/build
          tar czf mesa-turnip-aarch64.tar.gz src/freedreno src/gallium src/vulkan
          mv mesa-turnip-aarch64.tar.gz $GITHUB_WORKSPACE/

      - name: Upload Mesa artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mesa-turnip-aarch64
          path: mesa-turnip-aarch64.tar.gz
