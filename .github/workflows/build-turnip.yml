name: Build Turnip Vulkan Driver for ARM64 (Winlator-Compatible)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Mesa Turnip (AArch64)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare environment and dependencies
        run: |
          echo "ðŸ”§ Adding ARM64 architecture..."
          sudo dpkg --add-architecture arm64

          echo "ðŸ§© Fixing apt sources for both amd64 and arm64..."
          sudo tee /etc/apt/sources.list > /dev/null <<'EOF'
          # amd64 sources
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy main universe restricted multiverse
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-updates main universe restricted multiverse
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-backports main universe restricted multiverse
          deb [arch=amd64] http://security.ubuntu.com/ubuntu jammy-security main universe restricted multiverse
          # arm64 sources
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy main universe restricted multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-updates main universe restricted multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-backports main universe restricted multiverse
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports jammy-security main universe restricted multiverse
          EOF

          echo "ðŸ“¦ Updating and installing dependencies..."
          sudo apt-get clean
          sudo apt-get update -y

          sudo apt-get install -y \
            build-essential python3 python3-pip python3-setuptools python3-mako python3-jinja2 python3-yaml \
            ninja-build git wget unzip pkg-config bison flex cmake meson \
            libdrm-dev:arm64 libwayland-dev:arm64 wayland-protocols libxkbcommon-dev:arm64 \
            libxcb1-dev:arm64 libxcb-dri3-dev:arm64 libxcb-present-dev:arm64 libxcb-sync-dev:arm64 \
            libx11-dev:arm64 libxext-dev:arm64 libxdamage-dev:arm64 libxfixes-dev:arm64 libexpat1-dev:arm64 \
            libudev-dev:arm64 libvulkan-dev:arm64 libelf-dev:arm64 zlib1g-dev:arm64 \
            crossbuild-essential-arm64 qemu-user-static

      - name: Upgrade Meson to >= 1.4.0
        run: |
          python3 -m pip install --upgrade meson mako jinja2 pyyaml

      - name: Build and install glslangValidator
        run: |
          git clone --depth=1 https://github.com/KhronosGroup/glslang.git
          cd glslang
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local .
          ninja
          sudo ninja install
          /usr/local/bin/glslangValidator --version

      - name: Clone Mesa repository
        run: |
          git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          git submodule update --init --recursive

      - name: Create ARM64 cross file
        run: |
          cd mesa
          cat > cross_file.txt <<'EOF'
          [binaries]
          c = '/usr/bin/aarch64-linux-gnu-gcc'
          cpp = '/usr/bin/aarch64-linux-gnu-g++'
          ar = '/usr/bin/aarch64-linux-gnu-ar'
          strip = '/usr/bin/aarch64-linux-gnu-strip'
          pkgconfig = 'pkg-config'
          exe_wrapper = 'qemu-aarch64-static'

          [host_machine]
          system = 'linux'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

      - name: Configure Turnip build
        run: |
          cd mesa
          meson setup build \
            --cross-file cross_file.txt \
            -Dvulkan-drivers=freedreno \
            -Dplatforms=x11,wayland \
            -Dbuildtype=release \
            -Dprefix=/usr/local \
            -Dstrip=true \
            -Dgallium-drivers= \
            -Dllvm=false \
            -Dzstd=false

      - name: Build Turnip Vulkan driver
        run: |
          cd mesa/build
          ninja

      - name: Collect built driver
        run: |
          mkdir -p output
          find mesa/build -name "libvulkan_freedreno.so" -exec cp {} output/ \; || true
          ls -lh output/

      - name: Upload built driver artifact
        uses: actions/upload-artifact@v4
        with:
          name: libvulkan_freedreno
          path: output/libvulkan_freedreno.so
