name: Build Turnip Driver (AArch64, fully fixed + verified)

on:
  workflow_dispatch:
    inputs:
      mesa_version:
        description: "Mesa version to build (e.g. mesa-26.0.0 or main)"
        required: true
        default: "mesa-26.0.0"

jobs:
  build-aarch64:
    runs-on: ubuntu-latest

    steps:
      - name: Enable QEMU for arm64
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build inside arm64 Ubuntu container
        env:
          MESA_VERSION: ${{ github.event.inputs.mesa_version }}
        run: |
          docker run --rm --platform=linux/arm64 \
            -v "${{ github.workspace }}:/work" -w /work \
            ubuntu:22.04 /bin/bash -lc '
            set -ex
            export DEBIAN_FRONTEND=noninteractive

            # === System setup ===
            apt-get update
            apt-get install -y --no-install-recommends \
              build-essential git pkg-config ca-certificates wget xz-utils unzip zip \
              python3 python3-pip python3-setuptools python3-wheel python3-mako \
              cmake ninja-build meson \
              clang llvm llvm-dev libclang-dev \
              libx11-dev libx11-xcb-dev libxext-dev libxxf86vm-dev \
              libxdamage-dev libxfixes-dev libxshmfence-dev \
              libxcb1-dev libxcb-glx0-dev libxcb-dri2-0-dev libxcb-dri3-dev \
              libxcb-present-dev libxcb-sync-dev libxcb-randr0-dev \
              libxcb-shape0-dev libxcb-xfixes0-dev libxcb-shm0-dev \
              libwayland-dev wayland-protocols libwayland-egl-backend-dev \
              libegl1-mesa-dev libvulkan-dev libdrm-dev libexpat1-dev libudev-dev \
              libunwind-dev libpthread-stubs0-dev libselinux-dev libxrandr-dev \
              zlib1g-dev libpng-dev libtinfo-dev libelf-dev cmake ca-certificates \
              glslang-tools spirv-tools flex bison byacc

            # Upgrade Meson & Mako
            python3 -m pip install --user --upgrade "meson==1.5.0" mako
            export PATH="$HOME/.local/bin:$PATH"

            # === Build SPIR-V dependencies ===
            rm -rf /work/external_spirv && mkdir -p /work/external_spirv && cd /work/external_spirv

            # SPIRV-Headers
            git clone --depth 1 https://github.com/KhronosGroup/SPIRV-Headers.git
            cd SPIRV-Headers
            mkdir build && cd build
            cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr ..
            ninja install
            cd /work/external_spirv

            # SPIRV-Tools
            git clone --depth 1 https://github.com/KhronosGroup/SPIRV-Tools.git
            cd SPIRV-Tools
            mkdir build && cd build
            cmake -G Ninja -DCMAKE_BUILD_TYPE=Release \
              -DSPIRV-Headers_SOURCE_DIR=/work/external_spirv/SPIRV-Headers \
              -DCMAKE_INSTALL_PREFIX=/usr ..
            ninja install
            cd /work

            # === Build glslang ===
            rm -rf glslang && git clone --depth 1 https://github.com/KhronosGroup/glslang.git
            cd glslang
            mkdir build && cd build
            cmake -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DENABLE_OPT=ON \
              -DALLOW_EXTERNAL_SPIRV_TOOLS=ON \
              -DCMAKE_INSTALL_PREFIX=/usr \
              ..
            ninja install

            # Check glslang availability
            glslangValidator --version || true

            # === Build Mesa (Turnip) ===
            cd /work
            rm -rf mesa
            git clone https://gitlab.freedesktop.org/mesa/mesa.git
            cd mesa
            git fetch --tags

            if git rev-parse --verify --quiet "$MESA_VERSION" >/dev/null; then
              git checkout "$MESA_VERSION"
            elif git rev-parse --verify --quiet "refs/tags/$MESA_VERSION" >/dev/null; then
              git checkout "refs/tags/$MESA_VERSION"
            else
              echo "Version $MESA_VERSION not found; using main"
              git checkout main
            fi
            git submodule update --init --recursive

            # Apply Pipetto patches (Turnip)
            git remote add pipetto https://gitlab.freedesktop.org/Pipetto-crypto/mesa.git || true
            git fetch pipetto || true
            for commit in \
              9575886914d4a4ca09694c42e261f568ee8575d7 \
              d264c66f9950cb2331c22c21172a07520fb38c68 \
              96c4cb07b2a52124021c807f2c1ad4ab1f1cbf9c; do
              echo "Applying patch $commit"
              git cherry-pick $commit || git cherry-pick --abort || true
            done

            # === Configure and Build ===
            meson setup build \
              --prefix=/usr \
              -Dvulkan-drivers=freedreno \
              -Dgallium-drivers=freedreno,softpipe,llvmpipe \
              -Dllvm=enabled \
              -Dshared-llvm=true \
              -Dplatforms=x11,wayland \
              -Dbuildtype=release

            ninja -C build -j$(nproc)

            # === Collect artifacts ===
            mkdir -p /work/artifacts
            find build -name "*.so" -type f -exec cp -v {} /work/artifacts/ \;

            # Verify Turnip driver ELF
            echo "Verifying Turnip driver ELF info..."
            readelf -h /work/artifacts/libvulkan_freedreno.so || true
            readelf -d /work/artifacts/libvulkan_freedreno.so || true
            nm -D /work/artifacts/libvulkan_freedreno.so | grep -E "vk_icd|vkGet" || true

            echo "Mesa $(git rev-parse HEAD)" > /work/artifacts/BUILD_INFO.txt
            cd /work/artifacts
            zip -r9 /work/turnip-driver-aarch64-${MESA_VERSION:-main}.zip . || true
            echo "âœ… Build completed successfully"
          '

      - name: Upload Turnip build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: turnip-driver-aarch64-${{ github.event.inputs.mesa_version }}
          path: turnip-driver-aarch64-${{ github.event.inputs.mesa_version }}.zip
