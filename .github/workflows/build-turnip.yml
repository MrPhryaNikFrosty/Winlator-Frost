name: Build Mesa Turnip (Winlator Compatible)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-mako python3-setuptools python3-pip python3-wheel \
            cmake cmake-data ninja-build pkg-config git build-essential \
            bison flex libx11-dev libxext-dev libxdamage-dev libxfixes-dev \
            libxcb-glx0-dev libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev \
            libxcb-sync-dev libxcb-shm0-dev libxshmfence-dev libxxf86vm-dev \
            libwayland-dev wayland-protocols libexpat1-dev libdrm-dev \
            libelf-dev libunwind-dev libudev-dev libomxil-bellagio-dev \
            llvm llvm-dev clang spirv-tools \
            libpthread-stubs0-dev libpython3-dev libstdc++-12-dev

      - name: Build Latest glslang (>=12.2)
        run: |
          sudo rm -f /usr/bin/glslangValidator || true
          git clone https://github.com/KhronosGroup/glslang.git
          cd glslang
          git checkout main
          cmake -S . -B build -G "Ninja" -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j$(nproc)
          sudo cmake --install build
          glslangValidator --version

      - name: Clone Mesa Repository
        run: |
          git clone https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          # Optional: checkout stable commit
          # git checkout main

      - name: Build Mesa Turnip Driver
        run: |
          cd mesa
          meson setup build/ \
            --prefix=/usr \
            -Dvulkan-drivers=freedreno \
            -Dgallium-drivers=freedreno,softpipe,llvmpipe \
            -Dllvm=enabled \
            -Dshared-llvm=enabled \
            -Dplatforms=x11,wayland \
            -Dbuildtype=release
          ninja -C build
          mkdir -p ../artifacts
          cp -r build/src/freedreno/vulkan/*.so ../artifacts/ || true
          cp -r build/src/gallium/targets/*.so ../artifacts/ || true

      - name: Upload Compiled Turnip Driver
        uses: actions/upload-artifact@v4
        with:
          name: mesa-turnip-driver
          path: artifacts/
