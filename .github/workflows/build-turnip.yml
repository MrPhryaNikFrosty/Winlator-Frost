# =====================================================
# Mesa Turnip Builder for Winlator (AArch64)
# =====================================================

name: Build Mesa Turnip for Winlator

on:
  workflow_dispatch:

jobs:
  build:
    name: Mesa Turnip AArch64
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare environment
        run: |
          sudo dpkg --add-architecture arm64
          sudo sed -i 's|http://archive.ubuntu.com/ubuntu|http://ports.ubuntu.com/ubuntu-ports|g' /etc/apt/sources.list
          sudo apt-get update
          sudo apt-get install -y \
            git ninja-build meson python3-pip python3-mako llvm-dev libclang-dev \
            libdrm-dev libexpat1-dev libx11-dev libxext-dev libxcb-glx0-dev \
            libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev libxcb-sync-dev \
            libxshmfence-dev libxxf86vm-dev libwayland-dev wayland-protocols \
            libvulkan-dev bison flex cmake pkg-config zlib1g-dev wget unzip
          pip install --upgrade meson==1.5.0 mako

      - name: Clone Mesa
        run: |
          git clone --depth 1 --branch main https://gitlab.freedesktop.org/mesa/mesa.git mesa
          cd mesa
          mkdir -p build

      - name: Configure Meson
        run: |
          cd mesa/build
          meson setup \
            --prefix=/usr \
            --libdir=lib/aarch64-linux-gnu \
            --buildtype=release \
            -Dplatforms=x11,wayland \
            -Dgallium-drivers=llvmpipe \
            -Dvulkan-drivers=freedreno \
            -Dllvm=enabled \
            -Dshared-llvm=enabled \
            -Dglx=dri \
            -Dgles2=enabled \
            -Dopengl=true \
            -Dvulkan-layers=device-select \
            ..

      - name: Build Mesa Turnip
        run: |
          cd mesa/build
          ninja -v

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mesa-turnip-aarch64
          path: mesa/build/src/freedreno/vulkan/libvulkan_freedreno.so
