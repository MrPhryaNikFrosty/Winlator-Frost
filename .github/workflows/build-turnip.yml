name: Build Mesa Turnip (ARM64, cross-built with QEMU)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare host environment (install host and cross runtime)
        run: |
          set -e
          sudo apt-get update -y

          # Essential host packages + cross compilers + qemu
          sudo apt-get install -y --no-install-recommends \
            git wget curl ca-certificates software-properties-common \
            build-essential binutils make perl pkg-config cmake ninja-build \
            python3 python3-pip python3-venv python3-yaml python3-mako python3-setuptools python3-wheel \
            clang llvm qemu-user-static binfmt-support \
            crossbuild-essential-arm64 gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            libwayland-dev wayland-protocols libwayland-egl-backend-dev \
            libx11-dev libxext-dev libxdamage-dev libxfixes-dev \
            libxcb-glx0-dev libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev \
            libxcb-sync-dev libxshmfence-dev libxxf86vm-dev libvulkan-dev \
            libdrm-dev libexpat1-dev libelf-dev bison flex byacc zlib1g-dev \
            spirv-tools glslang-tools libclc-dev

          # Ensure Meson etc are available as new versions in user-local
          python3 -m pip install --upgrade --user meson mako pyyaml ninja

          # Make sure ~/.local/bin is in PATH for subsequent steps
          echo "$HOME/.local/bin" >> $GITHUB_PATH

          # Add arm64 multiarch and install minimal ARM64 runtime libs so qemu can run tests
          sudo dpkg --add-architecture arm64
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            libc6:arm64 libstdc++6:arm64 libgcc-s1:arm64 zlib1g:arm64 libexpat1:arm64 libdrm2:arm64

          # Create compatibility symlink expected by some qemu setups if missing
          if [ ! -f /lib/ld-linux-aarch64.so.1 ]; then
            if [ -f /lib/aarch64-linux-gnu/ld-linux-aarch64.so.1 ]; then
              sudo ln -sf /lib/aarch64-linux-gnu/ld-linux-aarch64.so.1 /lib/ld-linux-aarch64.so.1
            fi
          fi

          echo "Host environment prepared"
          echo "meson -> $(meson --version || true)"
          echo "qemu -> $(qemu-aarch64-static --version || true)"

      - name: Clone Mesa source
        run: |
          set -e
          if [ ! -d "${{ github.workspace }}/mesa" ]; then
            git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git "${{ github.workspace }}/mesa"
          else
            cd "${{ github.workspace }}/mesa"
            git fetch origin main || true
          fi
          ls -la "${{ github.workspace }}/mesa"

      - name: Build glslang (host; needed by Meson checks)
        run: |
          set -e
          cd "${{ github.workspace }}"
          if [ ! -d glslang ]; then
            git clone --depth=1 https://github.com/KhronosGroup/glslang.git
          fi
          cd glslang
          mkdir -p build && cd build
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_OPT=OFF -DCMAKE_INSTALL_PREFIX=/usr ..
          ninja -j$(nproc)
          sudo cp StandAlone/glslangValidator /usr/local/bin/
          /usr/local/bin/glslangValidator --version || true

      - name: Create Meson cross file & build Mesa (cross)
        env:
          MESON_ARGS: "-Dplatforms=x11,wayland -Dvulkan-drivers=freedreno -Dgallium-drivers=[] -Dbuildtype=release -Dllvm=disabled -Dshared-llvm=false"
        run: |
          set -e
          cd "${{ github.workspace }}/mesa"

          # Sanity check meson version (from user-local)
          echo "Using meson: $(which meson) $(meson --version)"

          # Write cross file that uses aarch64 cross compilers and qemu as exe_wrapper
          cat > cross_file.txt <<'EOF'
[binaries]
c = '/usr/bin/aarch64-linux-gnu-gcc'
cpp = '/usr/bin/aarch64-linux-gnu-g++'
ar = '/usr/bin/aarch64-linux-gnu-ar'
strip = '/usr/bin/aarch64-linux-gnu-strip'
pkgconfig = 'pkg-config'
exe_wrapper = '/usr/bin/qemu-aarch64-static'

[host_machine]
system = 'linux'
cpu_family = 'aarch64'
cpu = 'armv8'
endian = 'little'
EOF

          # Create build dir and run meson cross-configure
          rm -rf build
          mkdir -p build && cd build

          # Run meson setup (uses meson from ~/.local/bin)
          meson setup --cross-file ../cross_file.txt $MESON_ARGS --prefix=/usr/local ..

          # Build & install (installs into the host root under /usr/local)
          ninja -C . -j$(nproc)
          sudo ninja -C . install

      - name: Collect and upload libvulkan_freedreno.so (if present)
        run: |
          set -e
          # Try common output locations for the freedreno Vulkan driver and upload whichever exists
          PATHS=(
            "${{ github.workspace }}/mesa/build/src/freedreno/vulkan/libvulkan_freedreno.so"
            "${{ github.workspace }}/mesa/build/src/vulkan/drivers/freedreno/libvulkan_freedreno.so"
            "${{ github.workspace }}/mesa/build/src/freedreno/libvulkan_freedreno.so"
          )
          FOUND=""
          for p in "${PATHS[@]}"; do
            if [ -f "$p" ]; then
              FOUND="$p"
              break
            fi
          done
          if [ -z "$FOUND" ]; then
            echo "libvulkan_freedreno.so not found. Listing build tree for debugging:"
            find "${{ github.workspace }}/mesa/build" -maxdepth 4 -type f -printf '%p\n' || true
            exit 1
          fi
          echo "Found driver at: $FOUND"
          mkdir -p artifacts
          cp "$FOUND" artifacts/
          ls -la artifacts
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libvulkan_freedreno-arm64
          path: artifacts/
