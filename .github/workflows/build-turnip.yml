name: Build Turnip Vulkan Driver for ARM64 (Winlator-Compatible)

on:
  workflow_dispatch:

jobs:
  build-turnip:
    runs-on: ubuntu-22.04

    steps:
      # --- Enable QEMU emulation for ARM64 ---
      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      # --- Prepare Environment ---
      - name: Prepare Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl python3 python3-pip python3-venv
          # Check if pip supports --break-system-packages
          if pip install --help | grep -q break-system-packages; then
            pip install --break-system-packages --upgrade meson ninja
          else
            # Use virtualenv fallback for older pip versions
            python3 -m venv ~/.venv
            source ~/.venv/bin/activate
            pip install --upgrade meson ninja
          fi

      # --- Clone Mesa ---
      - name: Clone Mesa Source
        run: |
          git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          git log -1

      # --- Install Build Dependencies ---
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-mako python3-setuptools pkg-config cmake \
            llvm clang libclc-dev zlib1g-dev libdrm-dev libelf-dev \
            libexpat-dev bison flex libwayland-dev wayland-protocols \
            libx11-dev libxext-dev libxdamage-dev libxfixes-dev \
            libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev \
            libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev \
            libxcb-glx0-dev libxcb-shm0-dev byacc python3-packaging

      # --- Build SPIRV-Headers and SPIRV-Tools ---
      - name: Build SPIRV-Headers and SPIRV-Tools
        run: |
          git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Headers.git
          sudo cp -r SPIRV-Headers/include/spirv /usr/include/

          git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Tools.git
          cd SPIRV-Tools
          python3 utils/git-sync-deps
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DSPIRV_SKIP_TESTS=ON ..
          make -j$(nproc)
          sudo make install

      # --- Build glslang (robust) ---
      - name: Build glslang (robust)
        run: |
          git clone --depth=1 https://github.com/KhronosGroup/glslang.git
          cd glslang
          mkdir build && cd build

          # Try with SPIR-V optimization enabled, else retry without
          if ! cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_OPT=ON \
            -DALLOW_EXTERNAL_SPIRV_TOOLS=ON \
            -DSPIRV_TOOLS_INCLUDE_DIR=/usr/include/spirv-tools \
            -DSPIRV_TOOLS_LIBRARY_DIR=/usr/lib \
            -DCMAKE_INSTALL_PREFIX=/usr ..; then
            echo "SPIR-V tools not found properly, retrying with ENABLE_OPT=OFF..."
            rm -rf * && cmake \
              -DCMAKE_BUILD_TYPE=Release \
              -DENABLE_OPT=OFF \
              -DCMAKE_INSTALL_PREFIX=/usr ..
          fi

          make -j$(nproc)
          sudo make install

      # --- Build Mesa Turnip for ARM64 inside Docker ---
      - name: Build Mesa Turnip (ARM64)
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/work \
            ubuntu:24.04 \
            bash -c "
              set -e
              apt-get update && apt-get install -y \
                python3 python3-pip python3-venv python3-mako python3-setuptools \
                cmake pkg-config git llvm clang zlib1g-dev \
                libdrm-dev libexpat1-dev libwayland-dev wayland-protocols \
                libx11-dev libxext-dev libxdamage-dev libxfixes-dev \
                flex bison byacc && \
              if pip install --help | grep -q break-system-packages; then
                pip install --break-system-packages --upgrade meson ninja
              else
                python3 -m venv /opt/venv && \
                . /opt/venv/bin/activate && \
                pip install --upgrade meson ninja
              fi && \
              cd /work/mesa && \
              meson setup build/ \
                --prefix=/work/install \
                --libdir=lib \
                -Dplatforms=x11,wayland \
                -Dvulkan-drivers=freedreno \
                -Dgallium-drivers=freedreno \
                -Dbuildtype=release && \
              ninja -C build && \
              ninja -C build install
            "

      # --- Upload Compiled Turnip Vulkan Driver ---
      - name: Upload Turnip Vulkan Driver
        uses: actions/upload-artifact@v4
        with:
          name: Mesa-Turnip-ARM64
          path: install/lib/libvulkan_freedreno.so
