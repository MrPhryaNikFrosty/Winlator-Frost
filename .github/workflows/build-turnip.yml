name: Build Winlator (Turnip Version)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Fix missing submodule URL if not set
        run: |
          if ! grep -q "OpenXR-SDK" .gitmodules 2>/dev/null; then
            echo "Adding .gitmodules entry for OpenXR-SDK..."
            cat <<EOF >> .gitmodules
[submodule "app/src/main/cpp/OpenXR-SDK"]
    path = app/src/main/cpp/OpenXR-SDK
    url = https://github.com/KhronosGroup/OpenXR-SDK.git
EOF
          fi
          git submodule sync --recursive
          git submodule update --init --force --depth=1 --recursive || true

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            python3-pip python3-setuptools python3-wheel ninja-build \
            pkg-config libx11-dev libxext-dev libxdamage-dev libxfixes-dev \
            libx11-xcb-dev libxcb-dri3-dev libxcb-present-dev libxcb-sync-dev \
            libxshmfence-dev libxxf86vm-dev libwayland-dev wayland-protocols \
            libexpat1-dev bison flex cmake llvm clang git wget curl

      - name: Upgrade Meson to latest
        run: |
          pip3 install --upgrade meson mako

      - name: Clone Mesa
        run: |
          git clone https://gitlab.freedesktop.org/mesa/mesa.git --depth=1
          cd mesa
          git submodule update --init --recursive

      - name: Configure Mesa with Meson
        run: |
          cd mesa
          meson setup build \
            -Dgallium-drivers=freedreno,llvmpipe,softpipe \
            -Dvulkan-drivers=freedreno \
            -Dplatforms=x11,wayland \
            -Dllvm=true \
            -Dshared-llvm=true \
            -Dglx=dri \
            -Dgles1=true \
            -Dgles2=true \
            -Dopengl=true \
            -Dbuildtype=release \
            -Dprefix=/usr/local

      - name: Build Mesa
        run: |
          cd mesa
          ninja -C build

      - name: Install Mesa
        run: |
          cd mesa
          sudo ninja -C build install

      - name: Clone Winlator source
        run: |
          git clone https://github.com/brunodev85/Winlator.git --depth=1
          cd Winlator
          git submodule update --init --recursive || true

      - name: Replace Mesa build in Winlator
        run: |
          cd Winlator
          mkdir -p app/src/main/assets/mesa
          cp -r /usr/local/lib/* app/src/main/assets/mesa/ || true

      - name: Build Winlator APK
        run: |
          cd Winlator
          ./gradlew assembleRelease --no-daemon

      - name: Upload Winlator APK
        uses: actions/upload-artifact@v4
        with:
          name: Winlator-Turnip-Build
          path: Winlator/app/build/outputs/apk/release/*.apk
