# File: .github/workflows/build-mesa.yml
name: Build Turnip Vulkan Driver (AArch64, Winlator-Compatible)

on:
  workflow_dispatch:

jobs:
  build_turnip:
    name: Build Mesa Turnip (AArch64)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fix missing OpenXR-SDK submodule issue
        run: |
          if [ ! -f .gitmodules ]; then
            echo "[submodule \"app/src/main/cpp/OpenXR-SDK\"]" > .gitmodules
            echo "  path = app/src/main/cpp/OpenXR-SDK" >> .gitmodules
            echo "  url = https://github.com/KhronosGroup/OpenXR-SDK.git" >> .gitmodules
          fi
          git submodule sync --recursive
          git submodule update --init --recursive || true

      - name: Configure clean APT sources for arm64
        run: |
          sudo dpkg --add-architecture arm64
          sudo mv /etc/apt/sources.list /etc/apt/sources.list.backup
          cat <<'EOF' | sudo tee /etc/apt/sources.list
          deb [arch=amd64,arm64] http://ports.ubuntu.com/ jammy main restricted universe multiverse
          deb [arch=amd64,arm64] http://ports.ubuntu.com/ jammy-updates main restricted universe multiverse
          deb [arch=amd64,arm64] http://ports.ubuntu.com/ jammy-security main restricted universe multiverse
          EOF
          sudo apt-get clean
          for i in {1..3}; do sudo apt-get update && break || sleep 10; done

      - name: Install Mesa build dependencies
        run: |
          sudo apt-get install -y \
            python3-mako python3-pip ninja-build meson pkg-config git build-essential \
            python3-setuptools python3-wheel cmake bison flex libx11-dev libxext-dev \
            libxdamage-dev libxfixes-dev libxcb-glx0-dev libxcb-dri2-0-dev libxcb-dri3-dev \
            libxcb-present-dev libxcb-sync-dev libxcb-randr0-dev libxcb-shape0-dev \
            libxcb-xfixes0-dev libxcb-render0-dev libxcb-shm0-dev libxcb1-dev \
            libxshmfence-dev libxxf86vm-dev libdrm-dev libexpat1-dev zlib1g-dev \
            libwayland-dev wayland-protocols libvulkan-dev spirv-tools glslang-dev \
            libelf-dev llvm clang libclc-dev python3-jinja2 libpciaccess-dev \
            libunwind-dev libudev-dev libxrandr-dev libglvnd-dev glslang-tools

      - name: Upgrade Meson and build tools
        run: |
          sudo pip3 install --upgrade meson ninja mako jinja2

      - name: Clone Mesa main branch
        run: |
          git clone --branch main https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          git submodule update --init --recursive

      - name: Configure Mesa (Meson)
        run: |
          cd mesa
          meson setup build/ \
            -Dgallium-drivers=freedreno,llvmpipe \
            -Dvulkan-drivers=freedreno \
            -Dplatforms=x11,wayland \
            -Dllvm=true \
            -Dshared-llvm=true \
            -Dglx=dri \
            -Dgles1=true \
            -Dgles2=true \
            -Dopengl=true \
            -Dbuildtype=release \
            -Dprefix=/usr/local

      - name: Build Mesa
        run: |
          cd mesa
          ninja -C build/

      - name: Install Mesa
        run: |
          cd mesa
          sudo ninja -C build/ install

      - name: Package Turnip Vulkan Driver
        run: |
          mkdir -p mesa-output
          cp mesa/build/src/freedreno/vulkan/libvulkan_freedreno.so mesa-output/ || true
          cp mesa/build/meson-logs/meson-log.txt mesa-output/ || true

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mesa-turnip-aarch64-build
          path: mesa-output/
