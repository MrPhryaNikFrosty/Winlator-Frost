name: Build Turnip Vulkan Driver for ARM64 (Winlator-Compatible)

on:
  workflow_dispatch:

jobs:
  build-turnip:
    runs-on: ubuntu-22.04

    steps:
      - name: Prepare Workspace
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl

      - name: Clone Mesa from GitLab
        run: |
          git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          git log -1

      - name: Install Base Build Dependencies
        run: |
          sudo apt-get install -y \
            python3 python3-pip python3-mako python3-setuptools \
            ninja-build meson cmake pkg-config bison flex git \
            libx11-dev libxext-dev libxdamage-dev libxfixes-dev \
            libexpat-dev libdrm-dev libelf-dev zlib1g-dev \
            llvm clang libwayland-dev wayland-protocols \
            libxrandr-dev libxrender-dev libx11-xcb-dev \
            libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev \
            libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev libxcb-glx0-dev \
            libclc-dev byacc python3-packaging

      # ---- SPIRV Tools ----
      - name: Build SPIRV-Tools
        run: |
          git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Tools.git
          cd SPIRV-Tools
          python3 utils/git-sync-deps
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DSPIRV_SKIP_TESTS=ON ..
          make -j$(nproc)
          sudo make install

      # ---- glslang ----
      - name: Build glslang
        run: |
          git clone --depth=1 https://github.com/KhronosGroup/glslang.git
          cd glslang
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_OPT=ON ..
          make -j$(nproc)
          sudo make install

      # ---- ARM64 Mesa Build ----
      - name: Build Mesa (Turnip) for ARM64 inside Docker
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/work \
            ubuntu:22.04 \
            bash -c "
              set -e
              apt-get update && apt-get install -y \
                python3 python3-pip python3-mako python3-setuptools \
                meson ninja-build cmake pkg-config git llvm clang \
                zlib1g-dev libdrm-dev libexpat1-dev byacc flex bison \
                libwayland-dev wayland-protocols libx11-dev libxext-dev \
                libxdamage-dev libxfixes-dev libxcb-dri2-0-dev \
                libxcb-dri3-dev libxcb-present-dev libxcb-randr0-dev \
                libxcb-sync-dev libxcb-xfixes0-dev libxcb-glx0-dev && \
              cd /work/mesa && \
              meson setup build/ \
                --prefix=/work/install \
                --libdir=lib \
                -Dplatforms=x11,wayland \
                -Dvulkan-drivers=freedreno \
                -Dgallium-drivers=freedreno \
                -Dbuildtype=release && \
              ninja -C build && \
              ninja -C build install
            "

      - name: Upload Turnip Driver Artifact
        uses: actions/upload-artifact@v4
        with:
          name: turnip-arm64-driver
          path: install/lib/libvulkan_freedreno.so
