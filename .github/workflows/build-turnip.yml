name: Build Turnip for ARM64 (Winlator-Compatible)

on:
  workflow_dispatch:

jobs:
  build-turnip:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Mesa Source
        uses: actions/checkout@v4
        with:
          repository: mesa3d/mesa
          ref: main

      - name: Install Base Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 python3-pip python3-mako python3-setuptools \
            git ninja-build meson cmake pkg-config bison flex \
            libx11-dev libxext-dev libxdamage-dev libxfixes-dev \
            libexpat-dev libdrm-dev libelf-dev libomxil-bellagio-dev \
            zlib1g-dev libclc-dev llvm clang libwayland-dev wayland-protocols \
            libxrandr-dev libxrender-dev libx11-xcb-dev libxcb-dri2-0-dev \
            libxcb-dri3-dev libxcb-present-dev libxcb-randr0-dev \
            libxcb-sync-dev libxcb-xfixes0-dev libxcb-glx0-dev \
            byacc python3-packaging

      - name: Prepare SPIRV-Tools
        run: |
          git clone --depth=1 https://github.com/KhronosGroup/SPIRV-Tools.git
          cd SPIRV-Tools
          python3 utils/git-sync-deps
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DSPIRV_SKIP_TESTS=ON ..
          make -j$(nproc)
          sudo make install

      - name: Prepare glslang
        run: |
          git clone --depth=1 https://github.com/KhronosGroup/glslang.git
          cd glslang
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_OPT=ON ..
          make -j$(nproc)
          sudo make install

      - name: Run ARM64 Mesa Build inside Docker
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/work \
            ubuntu:22.04 \
            bash -c "
              apt-get update && apt-get install -y \
                python3 python3-pip python3-mako meson ninja-build cmake pkg-config \
                git llvm clang zlib1g-dev libdrm-dev byacc flex bison \
                libexpat1-dev libwayland-dev wayland-protocols \
                libx11-dev libxext-dev libxdamage-dev libxfixes-dev \
                libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev \
                libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev libxcb-glx0-dev && \
              cd /work && \
              meson setup build/ \
                --prefix=/work/install \
                --libdir=lib \
                -Dplatforms=x11,wayland \
                -Dvulkan-drivers=freedreno \
                -Dgallium-drivers=freedreno \
                -Dbuildtype=release && \
              ninja -C build && \
              ninja -C build install
            "

      - name: Upload Turnip Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: turnip-arm64
          path: install/lib/libvulkan_freedreno.so
