name: Build Turnip Vulkan Driver (AArch64, Winlator-Compatible)

on:
  workflow_dispatch:

jobs:
  build_turnip:
    name: ðŸ§© Build Mesa Turnip (AArch64)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Fix APT sources (avoid 404)
        run: |
          sudo sed -i 's|http://archive.ubuntu.com|http://azure.archive.ubuntu.com|g' /etc/apt/sources.list
          sudo sed -i 's|http://security.ubuntu.com|http://azure.archive.ubuntu.com|g' /etc/apt/sources.list
          sudo apt-get clean
          sudo apt-get update -y

      - name: Install dependencies
        run: |
          sudo apt-get install -y \
            build-essential python3 python3-pip python3-mako python3-numpy \
            python3-setuptools python3-wheel pkg-config ninja-build meson \
            git wget curl zip unzip cmake bison flex libx11-dev libxext-dev \
            libxdamage-dev libxfixes-dev libxcb-glx0-dev libxcb-dri2-0-dev \
            libxcb-dri3-dev libxcb-present-dev libxcb-sync-dev libxshmfence-dev \
            libxrandr-dev libwayland-dev wayland-protocols libdrm-dev \
            libexpat1-dev libelf-dev llvm clang libclc-dev spirv-tools \
            libvulkan-dev libomxil-bellagio-dev libtinfo5 libzstd-dev \
            zlib1g-dev libxcb1-dev libxcb-keysyms1-dev libxcb-randr0-dev \
            libxcb-shape0-dev libxcb-xfixes0-dev libxcb-icccm4-dev \
            libxcb-render-util0-dev libxcb-image0-dev libxcb-cursor-dev

      - name: Upgrade Meson to latest (â‰¥1.4)
        run: |
          sudo pip install --upgrade meson ninja mako

      - name: Clone Mesa (main branch)
        run: |
          git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git mesa
          cd mesa
          git submodule update --init --depth=1

      - name: Configure Mesa for Turnip (AArch64)
        run: |
          cd mesa
          mkdir -p build
          meson setup build \
            --buildtype=release \
            --prefix=/usr/local \
            -Dplatforms=x11,wayland \
            -Dvulkan-drivers=freedreno \
            -Dgallium-drivers=freedreno,llvmpipe \
            -Dllvm=true \
            -Dshared-llvm=true \
            -Dgles1=true \
            -Dgles2=true \
            -Dopengl=true \
            -Dglx=dri

      - name: Build Mesa Turnip
        run: |
          cd mesa/build
          ninja -j$(nproc)

      - name: Package Mesa Turnip Libraries
        run: |
          mkdir -p mesa-out/lib/aarch64-linux-gnu
          sudo cp -r /usr/local/lib/aarch64-linux-gnu/* mesa-out/lib/aarch64-linux-gnu/ || true
          zip -r mesa-turnip-libs-aarch64.zip mesa-out
          echo "Build completed successfully!"

      - name: Upload Mesa Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mesa-turnip-libs-aarch64
          path: mesa-turnip-libs-aarch64.zip

  build_winlator_apk:
    name: ðŸ“± Build Standalone Winlator APK
    runs-on: ubuntu-22.04
    needs: build_turnip

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Mesa Turnip libs
        uses: actions/download-artifact@v4
        with:
          name: mesa-turnip-libs-aarch64
          path: mesa-libs

      - name: Prepare Android SDK/NDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle wrapper
        run: |
          chmod +x gradlew

      - name: Build Winlator-compatible APK
        run: |
          ./gradlew assembleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: winlator-standalone-apk
          path: app/build/outputs/apk/release/*.apk
