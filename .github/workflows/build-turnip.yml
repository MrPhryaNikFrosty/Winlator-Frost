name: Build Turnip (Mesa for Winlator)

on:
  workflow_dispatch:
    inputs:
      mesa_version:
        description: "Mesa version tag or branch (e.g. mesa-26.0.1, mesa-25.2.5, or main)"
        required: false
        default: "main"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-mako python3-pip python3-setuptools meson ninja-build \
            llvm clang bison flex libdrm-dev libwayland-dev libx11-dev libxext-dev \
            libxdamage-dev libxfixes-dev libxcb-glx0-dev libxcb-dri2-0-dev libxcb-dri3-dev \
            libxcb-present-dev libxcb-sync-dev libxshmfence-dev libxxf86vm-dev \
            libexpat1-dev zlib1g-dev libelf-dev git pkg-config

      - name: Clone Mesa source
        run: |
          git clone https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          git fetch --tags
          if git rev-parse -q --verify "refs/tags/${{ github.event.inputs.mesa_version }}"; then
            git checkout tags/${{ github.event.inputs.mesa_version }}
          else
            echo "⚠️ Tag not found. Falling back to main branch..."
            git checkout main
          fi
          git submodule update --init --recursive

      - name: Apply Winlator Turnip patches
        run: |
          cd mesa
          git remote add pipetto https://gitlab.freedesktop.org/Pipetto-crypto/mesa.git
          git fetch pipetto
          # Apply the three patches in order
          git cherry-pick 9575886914d4a4ca09694c42e261f568ee8575d7 || true
          git cherry-pick d264c66f9950cb2331c22c21172a07520fb38c68 || true
          git cherry-pick 96c4cb07b2a52124021c807f2c1ad4ab1f1cbf9c || true

      - name: Build Mesa Turnip
        run: |
          cd mesa
          meson setup build/ \
            --prefix=/usr \
            -Dvulkan-drivers=freedreno \
            -Dgallium-drivers=freedreno,swrast \
            -Dllvm=enabled \
            -Dshared-llvm=enabled \
            -Dplatforms=x11,wayland,drm \
            -Dbuildtype=release
          ninja -C build

      - name: Upload Turnip driver artifact
        uses: actions/upload-artifact@v4
        with:
          name: turnip-driver-${{ github.event.inputs.mesa_version }}
          path: mesa/build/src/freedreno/vulkan/libvulkan_freedreno.so
