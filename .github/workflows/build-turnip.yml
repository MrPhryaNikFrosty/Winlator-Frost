name: Build Turnip Vulkan Driver for AArch64 (Winlator-Compatible)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    name: Build Mesa Turnip (Freedreno)

    steps:
      # --- STEP 1: Checkout source (no submodules yet) ---
      - name: Checkout repository without submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      # --- STEP 2: Remove broken submodule entry if it exists ---
      - name: Fix invalid submodule references
        run: |
          if [ -f .gitmodules ]; then
            echo "Fixing broken submodules..."
            grep "app/src/main/cpp/OpenXR-SDK" .gitmodules && {
              echo "Removing invalid OpenXR-SDK submodule..."
              git config -f .gitmodules --remove-section submodule."app/src/main/cpp/OpenXR-SDK" || true
              git rm --cached app/src/main/cpp/OpenXR-SDK || true
              rm -rf app/src/main/cpp/OpenXR-SDK || true
            }
            # Clean up .gitmodules if now empty
            [ ! -s .gitmodules ] && rm .gitmodules || true
          fi
          git submodule sync --recursive || true

      # --- STEP 3: Re-initialize valid submodules ---
      - name: Reinitialize valid submodules
        run: |
          git submodule update --init --recursive --depth=1 || true

      # --- STEP 4: Install Mesa dependencies ---
      - name: Install dependencies
        run: |
          sudo dpkg --add-architecture arm64
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            python3 python3-pip python3-setuptools python3-wheel \
            ninja-build cmake git pkg-config wget unzip \
            build-essential crossbuild-essential-arm64 \
            bison flex gettext \
            libx11-dev:arm64 libxext-dev:arm64 libxdamage-dev:arm64 libxfixes-dev:arm64 \
            libxcb-glx0-dev:arm64 libxcb-dri2-0-dev:arm64 libxcb-dri3-dev:arm64 \
            libxcb-present-dev:arm64 libxcb-sync-dev:arm64 libxshmfence-dev:arm64 \
            libxxf86vm-dev:arm64 libexpat1-dev:arm64 zlib1g-dev:arm64 \
            libdrm-dev:arm64 libwayland-dev:arm64 wayland-protocols \
            llvm llvm-dev clang libclang-dev libelf-dev:arm64 spirv-tools

      # --- STEP 5: Upgrade Meson ---
      - name: Upgrade Meson to latest
        run: |
          pip install --upgrade meson==1.9.1 Mako

      # --- STEP 6: Clone Mesa main branch ---
      - name: Clone Mesa main branch
        run: |
          git clone --depth=1 https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
          git submodule update --init --depth=1 --recursive || true

      # --- STEP 7: Create cross-compilation file ---
      - name: Create cross compilation file
        working-directory: mesa
        run: |
          cat <<EOF > cross_file.txt
          [binaries]
          c = '/usr/bin/aarch64-linux-gnu-gcc'
          cpp = '/usr/bin/aarch64-linux-gnu-g++'
          ar = '/usr/bin/aarch64-linux-gnu-ar'
          strip = '/usr/bin/aarch64-linux-gnu-strip'
          pkgconfig = '/usr/bin/pkg-config'
          [host_machine]
          system = 'linux'
          cpu_family = 'aarch64'
          cpu = 'aarch64'
          endian = 'little'
          EOF

      # --- STEP 8: Configure Mesa ---
      - name: Configure Mesa for Turnip
        working-directory: mesa
        run: |
          meson setup build \
            --prefix=/usr/local \
            --libdir=lib/aarch64-linux-gnu \
            --cross-file cross_file.txt \
            -Dgallium-drivers=freedreno,llvmpipe \
            -Dvulkan-drivers=freedreno \
            -Dplatforms=x11,wayland,android \
            -Dllvm=true -Dshared-llvm=true \
            -Dglx=dri -Dgles1=true -Dgles2=true -Dopengl=true \
            -Dbuildtype=release

      # --- STEP 9: Build Mesa Turnip ---
      - name: Build Turnip
        working-directory: mesa
        run: |
          meson compile -C build
          mkdir -p ../artifacts
          find build -type f -name "libvulkan_freedreno.so" -exec cp {} ../artifacts/ \; || true
          find build -type f -name "libgallium*.so" -exec cp {} ../artifacts/ \; || true
          ls -lh ../artifacts || true

      # --- STEP 10: Upload driver binaries ---
      - name: Upload Turnip build
        uses: actions/upload-artifact@v4
        with:
          name: mesa-turnip-libs
          path: artifacts/*.so
          if-no-files-found: warn

      # --- STEP 11: Upload logs ---
      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: mesa-turnip-logs
          path: mesa/build/meson-logs/meson-log.txt
          if-no-files-found: ignore
