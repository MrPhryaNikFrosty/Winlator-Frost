name: Build Turnip (Mesa for Winlator)

on:
  workflow_dispatch:
    inputs:
      mesa_version:
        description: "Mesa version tag or branch (e.g. mesa-26.0.0, mesa-25.3.0, or main)"
        required: true
        default: "mesa-26.0.0"

jobs:
  build-turnip:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        winlator_version: [ "10.1", "11.0" ]
    name: Build Turnip ${{ github.event.inputs.mesa_version }} for Winlator ${{ matrix.winlator_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-mako python3-pip ninja-build meson git llvm clang libexpat1-dev zip
          pip3 install meson==1.4.0 mako jinja2

      - name: Download Android NDK (r26d)
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip -O ndk.zip
          unzip -q ndk.zip
          mv android-ndk-r26d $HOME/android-ndk

      - name: Clone Mesa source (${{ github.event.inputs.mesa_version }})
        run: |
          git clone --branch ${{ github.event.inputs.mesa_version }} --depth 1 https://gitlab.freedesktop.org/mesa/mesa.git || \
          (echo "Branch or tag not found, trying as commit..." && git clone https://gitlab.freedesktop.org/mesa/mesa.git && cd mesa && git checkout ${{ github.event.inputs.mesa_version }})
          cd mesa
          git submodule update --init --recursive

      - name: Configure build for Turnip
        run: |
          cd mesa
          mkdir build && cd build

          # Create Meson cross-file for Android ARM64
          cat > cross_file.txt <<'EOF'
          [binaries]
          c = '/usr/bin/clang'
          cpp = '/usr/bin/clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          pkgconfig = '/usr/bin/pkg-config'
          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'
          [paths]
          prefix = '/usr/local'
          [properties]
          needs_exe_wrapper = true
          EOF

          # Configure differently for Winlator versions
          if [ "${{ matrix.winlator_version }}" = "10.1" ]; then
            meson setup . .. \
              --cross-file cross_file.txt \
              --buildtype=release \
              -Dplatforms=android \
              -Dgallium-drivers=freedreno \
              -Dvulkan-drivers=freedreno \
              -Dshared-glapi=true \
              -Dllvm=true \
              -Dandroid-stub=true \
              -Dbuild-tests=false \
              -Dgles1=disabled \
              -Dgles2=enabled
          else
            meson setup . .. \
              --cross-file cross_file.txt \
              --buildtype=release \
              -Dplatforms=android \
              -Dgallium-drivers=freedreno \
              -Dvulkan-drivers=freedreno \
              -Dshared-glapi=true \
              -Dllvm=true \
              -Dandroid-stub=true \
              -Dbuild-tests=false \
              -Dgles1=disabled \
              -Dgles2=enabled \
              -Dspirv-to-nir=true \
              -Dvalgrind=false
          fi

      - name: Build Turnip driver
        run: |
          cd mesa/build
          ninja -j$(nproc)

      - name: Package Turnip libraries
        run: |
          cd mesa/build
          mkdir -p ../../output/${{ matrix.winlator_version }}
          find . -name "*.so" -exec cp {} ../../output/${{ matrix.winlator_version }}/ \;
          cd ../../
          cd output/${{ matrix.winlator_version }}

          # Add Mesa version info
          echo "Mesa Version: ${{ github.event.inputs.mesa_version }}" > MESA_VERSION.txt
          git -C ../../mesa log -1 --pretty=format:"Commit: %H%nDate: %ad%nAuthor: %an%nSubject: %s" >> MESA_VERSION.txt

          zip -r ../../turnip-${{ github.event.inputs.mesa_version }}-winlator-${{ matrix.winlator_version }}.zip .
          cd ../../

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: turnip-${{ github.event.inputs.mesa_version }}-winlator-${{ matrix.winlator_version }}
          path: turnip-${{ github.event.inputs.mesa_version }}-winlator-${{ matrix.winlator_version }}.zip

  release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-22.04
    needs: build-turnip
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.zip
